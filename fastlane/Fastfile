default_platform(:ios)

platform :ios do
  desc "Build and upload Preview build to TestFlight"
  lane :preview do
    # CI環境のセットアップ（一時キーチェーンを作成）
    setup_ci if ENV['CI']

    # App Store Connect API Keyのセットアップ
    if ENV['APP_STORE_CONNECT_API_KEY_CONTENT']
      api_key = app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: false
      )
    end

    # 証明書のインポート
    import_certificate(
      certificate_path: ENV["BUILD_CERTIFICATE_PATH"],
      certificate_password: ENV["P12_PASSWORD"],
      keychain_name: "fastlane_tmp_keychain"
    )

    # プロビジョニングプロファイルのインストール
    install_provisioning_profile(
      path: ENV["BUILD_PROVISION_PROFILE_PATH"]
    )

    # Expo prebuildでネイティブプロジェクトを生成
    sh("cd .. && npx expo prebuild --platform ios --clean")

    # コード署名設定を更新
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/LinksDeck.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: "com.linkdeck.app",
      profile_name: ENV["PROVISIONING_PROFILE_SPECIFIER"]
    )

    # TestFlightから最新のビルド番号を取得
    latest_build = latest_testflight_build_number(
      app_identifier: "com.linkdeck.app",
      api_key: api_key
    )

    # ビルド番号を最新+1に設定
    increment_build_number(
      xcodeproj: "ios/LinksDeck.xcodeproj",
      build_number: latest_build + 1
    )

    # ビルドとアーカイブ
    build_app(
      scheme: "LinksDeck",
      workspace: "ios/LinksDeck.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.linkdeck.app" => ENV["PROVISIONING_PROFILE_SPECIFIER"]
        }
      }
    )

    # TestFlightにアップロード
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      apple_id: ENV["APPLE_ID"],
      team_id: ENV["APP_STORE_CONNECT_TEAM_ID"],
      api_key: api_key
    )
  end

  desc "Build and submit Production build to App Store"
  lane :production do
    # CI環境のセットアップ（一時キーチェーンを作成）
    setup_ci if ENV['CI']

    # App Store Connect API Keyのセットアップ
    if ENV['APP_STORE_CONNECT_API_KEY_CONTENT']
      api_key = app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: false
      )
    end

    # 証明書のインポート
    import_certificate(
      certificate_path: ENV["BUILD_CERTIFICATE_PATH"],
      certificate_password: ENV["P12_PASSWORD"],
      keychain_name: "fastlane_tmp_keychain"
    )

    # プロビジョニングプロファイルのインストール
    install_provisioning_profile(
      path: ENV["BUILD_PROVISION_PROFILE_PATH"]
    )

    # Expo prebuildでネイティブプロジェクトを生成
    sh("cd .. && npx expo prebuild --platform ios --clean")

    # コード署名設定を更新
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/LinksDeck.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: "com.linkdeck.app",
      profile_name: ENV["PROVISIONING_PROFILE_SPECIFIER"]
    )

    # TestFlightから最新のビルド番号を取得
    latest_build = latest_testflight_build_number(
      app_identifier: "com.linkdeck.app",
      api_key: api_key
    )

    # ビルド番号を最新+1に設定
    increment_build_number(
      xcodeproj: "ios/LinksDeck.xcodeproj",
      build_number: latest_build + 1
    )

    # ビルドとアーカイブ
    build_app(
      scheme: "LinksDeck",
      workspace: "ios/LinksDeck.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.linkdeck.app" => ENV["PROVISIONING_PROFILE_SPECIFIER"]
        }
      }
    )

    # App Store Connectにアップロード
    upload_to_app_store(
      force: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      precheck_include_in_app_purchases: false,
      api_key: api_key
    )
  end
end
