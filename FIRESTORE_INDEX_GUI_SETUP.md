# 🔍 Firestoreインデックス GUI設定ガイド

タグ別リンク一覧機能を使用するには、以下のインデックスをFirebase Consoleで作成する必要があります。

---

## 📋 必要なインデックス

### インデックス: タグ別リンク一覧用

このインデックスは、特定のタグが付いたリンクを日付順で取得するために必要です。

---

## 🖱️ Firebase Console での設定手順

### 1. Firebase Consoleにアクセス

1. [Firebase Console](https://console.firebase.google.com/) を開く
2. プロジェクト「**linkdeck-7ccde**」を選択
3. 左側のメニューから「**Firestore Database**」をクリック
4. 上部タブの「**インデックス**」をクリック
5. 「**複合**」タブを選択

### 2. 「インデックスを追加」をクリック

画面右上または中央の「**インデックスを追加**」ボタンをクリック

---

## ✏️ インデックスの設定内容

以下の内容を**正確に**入力してください：

### 基本設定

```
コレクションID: links
クエリスコープ: Collection
```

### フィールドの設定（順番通りに追加）

#### フィールド 1
```
フィールドパス: tags
順序: 配列に含まれる (Array-contains)
```

#### フィールド 2
```
フィールドパス: userId
順序: 昇順 (Ascending)
```

#### フィールド 3
```
フィールドパス: createdAt
順序: 降順 (Descending)
```

---

## 📸 設定画面のイメージ

インデックス作成画面では以下のように表示されます：

```
┌─────────────────────────────────────────────┐
│ 複合インデックスを作成                        │
├─────────────────────────────────────────────┤
│ コレクションID                               │
│ [links                              ▼]      │
│                                             │
│ クエリスコープ                               │
│ [Collection                         ▼]      │
│                                             │
│ フィールド                                   │
│ ┌─────────────────────────────────────┐    │
│ │ フィールドパス         順序            │    │
│ ├─────────────────────────────────────┤    │
│ │ tags              配列に含まれる ▼   │    │
│ │ userId            昇順 ▼            │    │
│ │ createdAt         降順 ▼            │    │
│ └─────────────────────────────────────┘    │
│                                             │
│ [キャンセル]              [作成]            │
└─────────────────────────────────────────────┘
```

---

## ⚠️ 重要な注意点

### フィールドの順序
フィールドは**必ずこの順番で**追加してください：
1. tags (配列に含まれる)
2. userId (昇順)
3. createdAt (降順)

順番が違うとエラーが発生します。

### 「配列に含まれる」の選択
`tags` フィールドの順序は、ドロップダウンから「**配列に含まれる**」または「**Array-contains**」を選択してください。「昇順」や「降順」ではありません。

---

## 🚀 作成後の確認

### 1. インデックスのステータス確認

作成後、インデックスのステータスが表示されます：

- 🟡 **作成中** - 数分待ってください（通常3〜10分）
- 🟢 **有効** - 使用可能になりました
- 🔴 **エラー** - 設定を確認してください

### 2. アプリで動作確認

インデックスが「**有効**」になったら：

1. アプリを完全に再起動（Expo Goを終了して再起動）
2. タグタブを開く
3. 任意のタグをタップ
4. そのタグが付いたリンク一覧が表示されることを確認

---

## 🐛 トラブルシューティング

### エラー: "The query requires an index"（まだ表示される）

**原因**:
- インデックスがまだ「作成中」
- インデックスの設定が間違っている
- アプリがキャッシュを使用している

**解決策**:
1. Firebase Console → Firestore Database → インデックス → 複合タブ
2. インデックスのステータスが「有効」になっているか確認
3. 「有効」なのにエラーが出る場合：
   - アプリを完全に終了して再起動
   - 開発サーバーを再起動（`npm start`）
   - 5〜10分待ってから再度試す

### インデックス作成が「エラー」になる

**原因**:
- フィールド名が間違っている（大文字小文字を区別）
- フィールドの順序が間違っている
- 既に同じインデックスが存在している

**解決策**:
1. エラーメッセージを確認
2. フィールド名を正確に入力（`tags`, `userId`, `createdAt`）
3. 既存のインデックスを削除してから再作成

### 既存のインデックスを削除する方法

1. Firestore Database → インデックス → 複合タブ
2. 削除したいインデックスの右側にある「⋮」をクリック
3. 「削除」を選択
4. 確認ダイアログで「削除」をクリック

---

## 💡 Tips

### インデックスが本当に必要？

はい、必要です。Firestoreでは以下の組み合わせを使うクエリには複合インデックスが必須です：

```typescript
// このクエリにはインデックスが必要
query(
  collection,
  where('tags', 'array-contains', tagName),  // 配列検索
  where('userId', '==', userId),              // フィルタ
  orderBy('createdAt', 'desc')                // 並び替え
)
```

### CLIで自動デプロイ

手動設定が面倒な場合は、Firebase CLIを使うこともできます：

```bash
firebase deploy --only firestore:indexes
```

詳細は [DEPLOY_INDEXES.md](DEPLOY_INDEXES.md) を参照してください。

---

## 📚 参考資料

- [Firestore インデックス公式ドキュメント](https://firebase.google.com/docs/firestore/query-data/indexing)
- [配列メンバーシップクエリ](https://firebase.google.com/docs/firestore/query-data/queries#array_membership)

---

**✨ インデックスを作成すれば、タグ別リンク一覧が正常に表示されるようになります！**
