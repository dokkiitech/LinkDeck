name: iOS Preview Build

on:
  pull_request:
    types: [labeled, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    # CDラベルがついている場合のみ実行
    if: contains(github.event.pull_request.labels.*.name, 'CD')
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          fastlane --version

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Decode Certificate and Provisioning Profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          echo "BUILD_CERTIFICATE_PATH=$PWD/certificate.p12" >> $GITHUB_ENV
          echo "BUILD_PROVISION_PROFILE_PATH=$PWD/profile.mobileprovision" >> $GITHUB_ENV

      - name: Build iOS App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          EXPO_PUBLIC_FIREBASE_API_KEY: ${{ secrets.EXPO_PUBLIC_FIREBASE_API_KEY }}
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_PROJECT_ID }}
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          EXPO_PUBLIC_FIREBASE_APP_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_APP_ID }}
        run: |
          fastlane ios preview_build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            LinksDeck.ipa
            build_info.txt
          retention-days: 3

      - name: Cleanup
        if: always()
        run: |
          rm -f certificate.p12 profile.mobileprovision

  deploy:
    needs: build
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          fastlane --version

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-build

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          IPA_PATH: ${{ github.workspace }}/LinksDeck.ipa
        run: |
          fastlane ios preview_upload

      - name: Post Build Success Comment
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ビルド情報を読み込み
          source build_info.txt

          # コメント内容を作成
          cat << EOF > comment.md
          ## ✅ iOS Preview Build & Deploy 成功

          **ビルド情報:**
          - ビルド番号: \`${BUILD_NUMBER}\`
          - バージョン: \`${VERSION}\`
          - コミット: \`${{ github.sha }}\`
          - ブランチ: \`${{ github.head_ref }}\`

          **TestFlight:**
          - アップロード完了（処理中）
          - 数分後に [App Store Connect](https://appstoreconnect.apple.com/apps) で確認できます

          **詳細:**
          - [ワークフロー実行](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          # PRにコメント投稿
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

      - name: Post Deploy Failure Comment
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ビルド情報を読み込み（存在する場合）
          if [ -f build_info.txt ]; then
            source build_info.txt
          else
            BUILD_NUMBER="不明"
            VERSION="不明"
          fi

          # 失敗コメント内容を作成
          cat << EOF > failure_comment.md
          ## ❌ iOS Preview Deploy 失敗

          **ビルド情報:**
          - ビルド番号: \`${BUILD_NUMBER}\`
          - バージョン: \`${VERSION}\`
          - コミット: \`${{ github.sha }}\`
          - ブランチ: \`${{ github.head_ref }}\`

          **考えられる原因:**
          - TestFlightの送信回数制限（1時間に複数回送信すると制限される場合があります）
          - App Store Connect API の一時的なエラー
          - ネットワークエラー

          **対処方法:**
          1. **送信制限の場合**: 1-2時間待ってから、GitHub Actionsの画面で「Re-run failed jobs」をクリック
             - ビルドは再実行されず、送信のみが再実行されます
             - アーティファクトは3日間保持されます
          2. **その他のエラー**: ワークフローログで詳細を確認してください

          **詳細:**
          - [ワークフロー実行](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ログを確認](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ github.job }})
          EOF

          # PRにコメント投稿
          gh pr comment ${{ github.event.pull_request.number }} --body-file failure_comment.md

      - name: Delete Build Artifacts After Successful Deploy
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 現在のワークフロー実行のアーティファクトを削除
          ARTIFACTS=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" --jq '.artifacts[].id')
          for artifact_id in $ARTIFACTS; do
            echo "Deleting artifact ID: $artifact_id"
            gh api -X DELETE "/repos/${{ github.repository }}/actions/artifacts/$artifact_id"
          done

      - name: Cleanup
        if: always()
        run: |
          rm -f build_info.txt comment.md failure_comment.md LinksDeck.ipa
