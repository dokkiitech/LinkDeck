name: iOS Production Build & Submit

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          fastlane --version

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Decode Certificate and Provisioning Profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          echo "BUILD_CERTIFICATE_PATH=$PWD/certificate.p12" >> $GITHUB_ENV
          echo "BUILD_PROVISION_PROFILE_PATH=$PWD/profile.mobileprovision" >> $GITHUB_ENV

      - name: Build iOS App
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          EXPO_PUBLIC_FIREBASE_API_KEY: ${{ secrets.EXPO_PUBLIC_FIREBASE_API_KEY }}
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_PROJECT_ID }}
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          EXPO_PUBLIC_FIREBASE_APP_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_APP_ID }}
        run: |
          fastlane ios production_build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            LinksDeck.ipa
            build_info.txt
          retention-days: 3

      - name: Cleanup
        if: always()
        run: |
          rm -f certificate.p12 profile.mobileprovision

  deploy:
    needs: build
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          fastlane --version

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-build

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          IPA_PATH: ${{ github.workspace }}/LinksDeck.ipa
        run: |
          fastlane ios production_upload

      - name: Post Build Success Summary
        if: success()
        run: |
          # ビルド情報を読み込み
          source build_info.txt

          # GitHub Actions Summary に出力
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ✅ iOS Production Build & Deploy 成功

          **ビルド情報:**
          - ビルド番号: \`${BUILD_NUMBER}\`
          - バージョン: \`${VERSION}\`
          - コミット: \`${{ github.sha }}\`
          - ブランチ: \`${{ github.ref_name }}\`

          **TestFlight:**
          - アップロード完了（処理中）
          - 数分後に [App Store Connect](https://appstoreconnect.apple.com/apps) で確認できます
          - **App Store への提出は手動で行ってください**

          **詳細:**
          - [ワークフロー実行](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Post Deploy Failure Summary
        if: failure()
        run: |
          # ビルド情報を読み込み（存在する場合）
          if [ -f build_info.txt ]; then
            source build_info.txt
          else
            BUILD_NUMBER="不明"
            VERSION="不明"
          fi

          # GitHub Actions Summary に出力
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ❌ iOS Production Deploy 失敗

          **ビルド情報:**
          - ビルド番号: \`${BUILD_NUMBER}\`
          - バージョン: \`${VERSION}\`
          - コミット: \`${{ github.sha }}\`
          - ブランチ: \`${{ github.ref_name }}\`

          **考えられる原因:**
          - **ビルド番号の重複**: 同じビルド番号が既にTestFlightにアップロード済み
          - **TestFlightの送信回数制限**: 1時間に複数回送信すると制限される場合があります
          - **App Store Connect API の一時的なエラー**
          - **ネットワークエラー**

          **対処方法:**

          ### ビルド番号重複エラーの場合
          エラーメッセージに「The bundle version must be higher than the previously uploaded version」と表示されている場合：
          - **buildジョブから再実行が必要です**
          - GitHub Actionsの画面で「Re-run all jobs」をクリックしてください
          - deployジョブのみの再実行では解決できません

          ### 送信制限・一時的なエラーの場合
          - 1-2時間待ってから「Re-run failed jobs」をクリック
          - ビルドは再実行されず、送信のみが再実行されます
          - アーティファクトは3日間保持されます

          **詳細:**
          - [ワークフロー実行](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ログを確認](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ github.job }})
          EOF

      - name: Delete Build Artifacts After Successful Deploy
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 現在のワークフロー実行のアーティファクトを削除
          ARTIFACTS=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" --jq '.artifacts[].id')
          for artifact_id in $ARTIFACTS; do
            echo "Deleting artifact ID: $artifact_id"
            gh api -X DELETE "/repos/${{ github.repository }}/actions/artifacts/$artifact_id"
          done

      - name: Cleanup
        if: always()
        run: |
          rm -f build_info.txt LinksDeck.ipa
